#####################################################################
# FLY-LLL PLUS Buffer Standalone Integration
#####################################################################
# Universal buffer integration for FLY-LLL PLUS Buffer
#
# Features:
# - BUFFER_UNLOAD_FILAMENT: Complete unload with buffer retraction
# - BUFFER_LOAD_FILAMENT: Complete load with automatic engagement
# - Auto-homing if printer not homed
# - Temperature management
# - Parking position for safe filament changes
# - Buffer retraction until runout sensor detects no filament
#####################################################################

#####################################################################
# Configuration Variables
#####################################################################
# Configure these variables to match your printer setup

[gcode_macro _BUFFER_STANDALONE_VARS]
variable_version: "1.1.3"                        # Configuration version
variable_park_x: 325.0                           # X position for filament change parking
variable_park_y: 348.0                           # Y position for filament change parking
variable_park_min_z: 10.0                        # Minimum Z height for parking
variable_unload_length: 125.0                    # Length to unload from hotend
variable_unload_purge_length: 25.0               # Purge length before unloading
variable_unload_temp: 250                        # Default unload temperature (°C)
variable_unload_speed: 7.0                       # Unload speed (mm/s)
variable_cooldown: "Yes"                         # Default cooldown after load/unload? 'Yes'/'No'
variable_cooldown_temp: 150                      # Default cooldown temperature (°C)
variable_load_temp: 250                          # Default load temperature (°C)
variable_load_purge_length: 50.0                 # Purge length after loading
variable_load_speed: 7.0                         # Load speed (mm/s)
variable_load_retract_length: 10.0               # Retract length after purge to minimize oozing (mm)
variable_engage_length: 20.0                     # Extruder engagement distance for loading (mm)
variable_nozzle_clean_macro: "CLEAN_NOZZLE"      # Name of nozzle cleaning macro to call after load/unload (empty = disabled)
variable_hotend_path_length: 100.0               # Distance from nozzle tip to extruder in mm (used for calculating retraction timing)
variable_buffer_retract_delay: 2.0               # Delay (seconds) before starting buffer retraction - calculated dynamically based on hotend_path_length and speed
variable_buffer_motor_rpm: 260                   # Buffer motor speed in RPM (from buffer firmware SPEED variable, default: 260 RPM)
variable_extruder_motor_rpm: 79                  # Extruder motor speed in RPM (calculated from rotation_distance=48.02976mm, gear_ratio=9:1, at 7.0mm/s = ~79 RPM)
gcode:

#####################################################################
# BUFFER_UNLOAD_FILAMENT - Standalone Unload with Buffer Integration
#####################################################################
# Complete filament unload macro with buffer retraction
#
# Parameters:
#   TEMP: Unload temperature in °C (default: 250)
#   SPEED_MMsec: Unload speed in mm/s (default: 15)
#   COOL: Cool down after unload? 'Yes'/'No' (default: from variable_cooldown)
#   COOL_TEMP: Cool down temperature in °C (default: from variable_cooldown_temp)
#   UNLOAD_LENGTH: Override unload length in mm (uses default if not specified)
#
# Usage:
#   BUFFER_UNLOAD_FILAMENT
#   BUFFER_UNLOAD_FILAMENT TEMP=230
#   BUFFER_UNLOAD_FILAMENT TEMP=230 SPEED_MMsec=5
#####################################################################

[gcode_macro BUFFER_UNLOAD_FILAMENT]
description: Unload filament from hotend and retract buffer until runout detected
gcode:
    # Get configuration from buffer standalone variables
    {% set buffer_vars = printer["gcode_macro _BUFFER_STANDALONE_VARS"] %}
    {% set park_x = buffer_vars.park_x|float %}
    {% set park_y = buffer_vars.park_y|float %}
    {% set park_min_z = buffer_vars.park_min_z|float %}
    {% set unload_length = buffer_vars.unload_length|float %}
    {% set unload_purge_length = buffer_vars.unload_purge_length|float %}
    {% set default_temp = buffer_vars.unload_temp|int %}
    {% set default_speed = buffer_vars.unload_speed|float %}
    {% set default_cooldown = buffer_vars.cooldown|string %}
    {% set default_cooldown_temp = buffer_vars.cooldown_temp|int %}
    {% set hotend_path_length = buffer_vars.hotend_path_length|float %}
    {% set buffer_retract_delay = buffer_vars.buffer_retract_delay|float %}
    
    # Allow parameter overrides
    {% set temp = params.TEMP|default(default_temp)|int %}
    {% set speed_mmsec = params.SPEED_MMsec|default(default_speed)|float %}
    {% set speed = speed_mmsec * 60 %}  # Convert to mm/min
    {% set cool = params.COOL|default(default_cooldown)|string %}
    {% set cool_temp = params.COOL_TEMP|default(default_cooldown_temp)|int %}
    {% set override_unload_length = params.UNLOAD_LENGTH|default(0)|float %}
    {% if override_unload_length > 0 %}
        {% set unload_length = override_unload_length %}
    {% endif %}
    
    # Get max velocity from extruder config and ensure speed doesn't exceed it
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity|int * 60 %}
    {% if speed > max_velocity %}
        {% set speed = max_velocity %}
    {% endif %}
    
    RESPOND MSG="BUFFER_UNLOAD_FILAMENT starting..."
    RESPOND MSG="Park: X={park_x} Y={park_y} Z_min={park_min_z}"
    RESPOND MSG="Unload: {unload_length}mm | Purge: {unload_purge_length}mm | Temp: {temp}°C | Speed: {speed_mmsec}mm/s"
    
    # Save G-code state
    SAVE_GCODE_STATE NAME=buffer_unload_state
    
    # Step 1: Auto-home if not homed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        RESPOND MSG="Printer not homed - auto-homing before unload..."
        SET_DISPLAY_TEXT MSG="Homing..."
        G28  # Home all axes
        M400  # Wait for homing to complete
        RESPOND MSG="Homing complete - proceeding with unload"
    {% endif %}
    
    # Step 2: Park toolhead (only if not printing/paused)
    {% if printer.print_stats.state not in ['printing', 'paused'] %}
        # Raise Z if needed
        {% if printer.toolhead.position.z|float < park_min_z|float %}
            G90
            G0 Z{park_min_z|float} F3600
            M400
        {% endif %}
        
        # Move to park position
        G90
        G0 X{park_x|float} Y{park_y|float} F9000
        M400
        RESPOND MSG="Toolhead parked at X={park_x} Y={park_y}"
    {% endif %}
    
    # Step 3: Temperature management
    {% if printer.print_stats.state not in ['printing', 'paused'] %}
        {% if 'TEMP' not in params %}
            {% if (printer.extruder.target == 0) or (printer.extruder.target < printer.configfile.settings['extruder'].min_extrude_temp) %}
                SET_DISPLAY_TEXT MSG="Unload hotend heating..."
                RESPOND MSG="Unload hotend heating to {temp}°C..."
                SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
                TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
                M117
            {% elif printer.extruder.target != 0 and printer.extruder.target >= printer.configfile.settings['extruder'].min_extrude_temp %}
                SET_DISPLAY_TEXT MSG="Unloading hotend..."
                RESPOND MSG="Unloading hotend at {printer.extruder.target|int}°C..."
                TEMPERATURE_WAIT SENSOR=extruder MINIMUM={printer.extruder.target|int -2} MAXIMUM={printer.extruder.target|int + 5}
            {% endif %}
        {% else %}
            SET_DISPLAY_TEXT MSG="Unload hotend heating to {temp}°C"
            RESPOND MSG="Unload hotend heating to {temp}°C"
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
            TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
        {% endif %}
    {% endif %}
    
    # Step 4: Unload filament from hotend
    RESPOND MSG="Starting filament unload from hotend..."
    M83  # Relative extrusion
    G92 E0  # Reset extruder
    
    # Purge to prevent cold end clogging
    RESPOND MSG="Purging {unload_purge_length}mm to clear cold end..."
    G1 E{unload_purge_length|float} F{speed|int}
    M400
    
    # Small retract to break adhesion
    G1 E-5 F{speed|int}
    M400
    
    # Calculate initial retraction distance and delay for simultaneous operation
    # Initial retraction: 20-30% of hotend path or 20mm minimum (whichever is larger, capped at 30mm)
    {% set initial_retract_pct = 0.25 %}  # 25% of hotend path
    {% set min_initial_retract = 20.0 %}
    {% set max_initial_retract = 30.0 %}
    {% set calculated_initial = hotend_path_length * initial_retract_pct %}
    {% if calculated_initial < min_initial_retract %}
        {% set initial_retract_length = min_initial_retract %}
    {% elif calculated_initial > max_initial_retract %}
        {% set initial_retract_length = max_initial_retract %}
    {% else %}
        {% set initial_retract_length = calculated_initial %}
    {% endif %}
    
    # Calculate remaining retraction after initial phase
    {% set remaining_retract_length = unload_length - initial_retract_length %}
    {% if remaining_retract_length < 0 %}
        {% set remaining_retract_length = 0 %}
        {% set initial_retract_length = unload_length %}
    {% endif %}
    
    # Calculate delay dynamically: time to pull initial retract + motor acceleration + safety margin
    # Time to pull initial retract = distance / speed
    {% set initial_retract_time = initial_retract_length / speed_mmsec %}
    {% set motor_accel_time = 0.3 %}  # Estimated motor acceleration time (seconds)
    {% set safety_margin = 0.2 %}  # Safety margin (seconds)
    {% set calculated_delay = initial_retract_time + motor_accel_time + safety_margin %}
    # Use calculated delay or configured delay, whichever is larger (safety)
    {% if calculated_delay > buffer_retract_delay %}
        {% set actual_delay = calculated_delay %}
    {% else %}
        {% set actual_delay = buffer_retract_delay %}
    {% endif %}
    
    # Phase 1: Initial retraction to disengage filament from hotend
    RESPOND MSG="Phase 1: Initial retraction {initial_retract_length|round(1)}mm to disengage from hotend..."
    RESPOND MSG="Calculated delay: {actual_delay|round(2)}s (initial: {initial_retract_time|round(2)}s + accel: {motor_accel_time}s + margin: {safety_margin}s)"
    G1 E-{initial_retract_length|float} F{speed|int}
    M400  # Wait for initial retraction to complete
    
    # Brief delay to ensure filament is disengaged before buffer starts
    {% set delay_ms = (actual_delay * 1000) | int %}
    G4 P{delay_ms}  # Wait for disengagement
    
    # Phase 2: Start buffer retraction (simultaneous with remaining hotend retraction)
    RESPOND MSG="Phase 2: Starting buffer retraction (delay: {actual_delay|round(2)}s)..."
    SET_PIN PIN=_Retract_Button VALUE=0  # Press retract button (LOW = pressed)
    M400  # Brief wait to ensure buffer starts
    
    # Phase 3: Continue remaining hotend retraction while buffer is running
    {% if remaining_retract_length > 0 %}
        RESPOND MSG="Phase 3: Continuing hotend retraction {remaining_retract_length|round(1)}mm (buffer running simultaneously)..."
        G1 E-{remaining_retract_length|float} F{speed|int}
        M400  # Wait for remaining retraction to complete
    {% endif %}
    
    RESPOND MSG="Hotend unload complete - buffer continuing retraction until runout detected..."
    
    # Step 5: Continue buffer retraction until runout detected
    # Buffer is already retracting, now we just need to monitor and stop when done
    Buffer_Retract_Until_Runout TIMEOUT=60 POLL=0.5
    
    # Call nozzle cleaning macro if configured (before cooldown)
    {% set nozzle_clean_macro = buffer_vars.nozzle_clean_macro|string|trim %}
    {% if nozzle_clean_macro and nozzle_clean_macro != "" %}
        RESPOND MSG="Running nozzle cleaning: {nozzle_clean_macro}..."
        {% if nozzle_clean_macro == "CLEAN_NOZZLE" %}
            CLEAN_NOZZLE
        {% elif nozzle_clean_macro == "NOZZLE_CLEAN" %}
            NOZZLE_CLEAN
        {% elif nozzle_clean_macro == "CLEAN" %}
            CLEAN
        {% elif nozzle_clean_macro == "NOZZLE_CLEANING" %}
            NOZZLE_CLEANING
        {% else %}
            RESPOND MSG="⚠ Unknown nozzle cleaning macro: {nozzle_clean_macro}"
            RESPOND MSG="Please add it to the conditional check or call it manually"
        {% endif %}
        M400
    {% endif %}
    
    # Step 6: Optional cooldown (last step)
    {% if cool|lower in ['yes', 'true'] %}
        {% if printer.print_stats.state not in ['printing', 'paused'] and (temp >= printer.configfile.settings['extruder'].min_extrude_temp) %}
            SET_DISPLAY_TEXT MSG="Post unload hotend cooling..."
            RESPOND MSG="Post unload hotend cooling to {cool_temp}°C..."
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cool_temp|int}
            M117
        {% elif printer.print_stats.state in ['printing', 'paused'] %}
            SET_DISPLAY_TEXT MSG="Unload cooling denied, print in progress!"
            RESPOND MSG="Unload cooling denied, print in progress!"
        {% endif %}
    {% endif %}
    
    # Restore G-code state
    RESTORE_GCODE_STATE NAME=buffer_unload_state
    
    M400
    SET_DISPLAY_TEXT MSG="BUFFER_UNLOAD_FILAMENT operation complete!"
    RESPOND MSG="BUFFER_UNLOAD_FILAMENT operation complete!"


#####################################################################
# BUFFER_LOAD_FILAMENT - Standalone Load with Buffer Integration
#####################################################################
# Complete filament load macro with buffer feeding and extruder engagement
# Works with or without Demon Klipper Essentials Unified
#
# Parameters:
#   TEMP: Load temperature in °C (default: 250)
#   ENGAGE_LENGTH: Extruder engagement distance in mm (default: 20)
#   PURGE_LENGTH: Purge length after load in mm (default: 25)
#   RETRACT_LENGTH: Retract length after purge to minimize oozing in mm (default: 10)
#   COOL: Cool down after load? 'Yes'/'No' (default: from variable_cooldown)
#   COOL_TEMP: Cool down temperature in °C (default: from variable_cooldown_temp)
#
# Note: This macro assumes filament is already at the extruder mouth.
#       The buffer firmware automatically feeds filament when inserted.
#
# Usage:
#   BUFFER_LOAD_FILAMENT
#   BUFFER_LOAD_FILAMENT TEMP=230
#   BUFFER_LOAD_FILAMENT TEMP=230 ENGAGE_LENGTH=25
#   BUFFER_LOAD_FILAMENT TEMP=230 RETRACT_LENGTH=5
#####################################################################

[gcode_macro BUFFER_LOAD_FILAMENT]
description: Load filament from buffer into hotend with automatic engagement
gcode:
    # Get configuration from buffer standalone variables
    {% set buffer_vars = printer["gcode_macro _BUFFER_STANDALONE_VARS"] %}
    {% set park_x = buffer_vars.park_x|float %}
    {% set park_y = buffer_vars.park_y|float %}
    {% set park_min_z = buffer_vars.park_min_z|float %}
    {% set load_purge_length = buffer_vars.load_purge_length|float %}
    {% set default_temp = buffer_vars.load_temp|int %}
    {% set default_retract_length = buffer_vars.load_retract_length|float %}
    {% set default_engage_length = buffer_vars.engage_length|float %}
    {% set default_cooldown = buffer_vars.cooldown|string %}
    {% set default_cooldown_temp = buffer_vars.cooldown_temp|int %}
    
    # Allow parameter overrides
    {% set temp = params.TEMP|default(default_temp)|int %}
    {% set engage_length = params.ENGAGE_LENGTH|default(default_engage_length)|float %}
    {% set purge_length = params.PURGE_LENGTH|default(load_purge_length)|float %}
    {% set retract_length = params.RETRACT_LENGTH|default(default_retract_length)|float %}
    {% set cool = params.COOL|default(default_cooldown)|string %}
    {% set cool_temp = params.COOL_TEMP|default(default_cooldown_temp)|int %}
    
    # Get max velocity from extruder config
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity|int * 60 %}
    
    RESPOND MSG="BUFFER_LOAD_FILAMENT starting..."
    RESPOND MSG="Park: X={park_x} Y={park_y} Z_min={park_min_z}"
    RESPOND MSG="Engage: {engage_length}mm | Purge: {purge_length}mm | Temp: {temp}°C"
    RESPOND MSG="Note: Assumes filament is already at extruder mouth (buffer auto-feeds on insertion)"
    
    # Save G-code state
    SAVE_GCODE_STATE NAME=buffer_load_state
    
    # Step 1: Auto-home if not homed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        RESPOND MSG="Printer not homed - auto-homing before load..."
        SET_DISPLAY_TEXT MSG="Homing..."
        G28  # Home all axes
        M400  # Wait for homing to complete
        RESPOND MSG="Homing complete - proceeding with load"
    {% endif %}
    
    # Step 2: Park toolhead (only if not printing/paused)
    {% if printer.print_stats.state not in ['printing', 'paused'] %}
        # Raise Z if needed
        {% if printer.toolhead.position.z|float < park_min_z|float %}
            G90
            G0 Z{park_min_z|float} F3600
            M400
        {% endif %}
        
        # Move to park position
        G90
        G0 X{park_x|float} Y{park_y|float} F9000
        M400
        RESPOND MSG="Toolhead parked at X={park_x} Y={park_y}"
    {% endif %}
    
    # Step 3: Verify filament is at extruder mouth
    # Buffer firmware automatically feeds filament when inserted, so it should be detected
    {% if not printer["filament_switch_sensor filament_sensor"].filament_detected %}
        RESPOND MSG="⚠ ERROR: No filament detected at extruder mouth!"
        RESPOND MSG="Please insert filament - buffer will auto-feed it to extruder"
        RESPOND MSG="Then run BUFFER_LOAD_FILAMENT again"
        RESTORE_GCODE_STATE NAME=buffer_load_state
        ABORT
    {% endif %}
    
    RESPOND MSG="✓ Filament detected at extruder - heating hotend before engagement..."
    
    # Step 4: Heat hotend (required before extruder can move filament)
    RESPOND MSG="Heating hotend to {temp}°C..."
    SET_DISPLAY_TEXT MSG="Heating to {temp}°C..."
    
    {% if printer.print_stats.state not in ['printing', 'paused'] %}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
        RESPOND MSG="✓ Hotend reached {temp}°C"
    {% else %}
        # Check if current temperature is above minimum extrude temp
        {% if printer.extruder.temperature < printer.configfile.settings['extruder'].min_extrude_temp %}
            RESPOND MSG="⚠ ERROR: Hotend below minimum extrude temperature!"
            RESPOND MSG="Current: {printer.extruder.temperature|int}°C | Required: {printer.configfile.settings['extruder'].min_extrude_temp|int}°C"
            RESTORE_GCODE_STATE NAME=buffer_load_state
            ABORT
        {% else %}
            RESPOND MSG="Print in progress - using current temperature: {printer.extruder.temperature|int}°C"
        {% endif %}
    {% endif %}
    
    RESPOND MSG="Starting extruder engagement..."
    SET_DISPLAY_TEXT MSG="Engaging filament..."
    
    # Step 5: Extruder engagement with retry logic
    {% set engagement_success = False %}
    {% set max_retries = 3 %}
    {% set retry_wait = 5000 %}  # 5 seconds between retries
    
    {% for attempt in range(max_retries) %}
        {% if not engagement_success %}
            {% set attempt_num = attempt + 1 %}
            RESPOND MSG="Engagement attempt {attempt_num}/{max_retries}: Moving extruder {engage_length}mm forward..."
            SET_DISPLAY_TEXT MSG="Engaging filament (attempt {attempt_num})..."
            
            # Ensure relative extrusion mode
            M83  # Relative extrusion
            G92 E0  # Reset extruder position
            
            # Move extruder forward to engage filament
            G1 E{engage_length|float} F{max_velocity|int}
            M400
            
        # Brief pause to let buffer react (buffer may start feeding if HALL1 triggered)
        G4 P1000  # 1 second pause
        
        # Engagement test - check if filament is still present after engagement attempt
            RESPOND MSG="Testing engagement..."
            
            # Check if runout sensor still shows filament (indicates engagement)
            # If buffer started feeding (HALL1 triggered), filament should still be present
            {% if printer["filament_switch_sensor filament_sensor"].filament_detected %}
                # Filament still present - try small retract test to confirm engagement
                RESPOND MSG="Filament detected - performing retract test..."
                
                # Reset position for retract test
                G92 E0
                # Try to retract 3mm - if filament is engaged, this should work
                G1 E-3 F{max_velocity|int}
                M400
                
                # Check again if filament is still present after retract
                # If engaged, buffer may feed forward again (HALL1), so filament should still be detected
                {% if printer["filament_switch_sensor filament_sensor"].filament_detected %}
                    {% set engagement_success = True %}
                    RESPOND MSG="✓ Engagement successful on attempt {attempt_num}!"
                    SET_DISPLAY_TEXT MSG="Filament engaged!"
                {% else %}
                    RESPOND MSG="⚠ Retract test failed - filament lost contact"
                {% endif %}
            {% else %}
                RESPOND MSG="⚠ Filament not detected after engagement attempt"
            {% endif %}
            
            {% if not engagement_success %}
                RESPOND MSG="⚠ Attempt {attempt_num} failed - filament not engaged"
                {% if attempt_num < max_retries %}
                    RESPOND MSG="Waiting {retry_wait / 1000 | int}s before retry..."
                    G4 P{retry_wait | int}
                {% endif %}
            {% endif %}
        {% endif %}
    {% endfor %}
    
    {% if not engagement_success %}
        RESPOND MSG="⚠ ERROR: Failed to engage filament after {max_retries} attempts"
        RESPOND MSG="Please check filament position and try again manually"
        SET_PIN PIN=_Feed_Button VALUE=1  # Ensure feed button is released
        SET_PIN PIN=_Retract_Button VALUE=1  # Ensure retract button is released
        RESTORE_GCODE_STATE NAME=buffer_load_state
        ABORT
    {% endif %}
    
    # Step 6: Purge filament
    RESPOND MSG="Purging {purge_length}mm of filament..."
    SET_DISPLAY_TEXT MSG="Purging filament..."
    
    M83  # Relative extrusion
    G92 E0  # Reset extruder
    G1 E{purge_length|float} F{max_velocity|int}
    M400
    
    RESPOND MSG="✓ Purge complete - {purge_length}mm extruded"
    
    # Step 7: Quick retract to minimize oozing
    RESPOND MSG="Retracting {retract_length}mm at 30mm/sec to minimize oozing..."
    SET_DISPLAY_TEXT MSG="Retracting to prevent ooze..."
    
    G92 E0  # Reset extruder position
    G1 E-{retract_length|float} F1800  # 30mm/sec = 1800 mm/min
    M400
    
    RESPOND MSG="✓ Retract complete - {retract_length}mm retracted"
    
    # Ensure buttons are released
    SET_PIN PIN=_Feed_Button VALUE=1
    SET_PIN PIN=_Retract_Button VALUE=1
    M400
    
    # Restore G-code state
    RESTORE_GCODE_STATE NAME=buffer_load_state
    
    M400
    SET_DISPLAY_TEXT MSG="BUFFER_LOAD_FILAMENT complete!"
    RESPOND MSG="BUFFER_LOAD_FILAMENT operation complete!"
    RESPOND MSG="Filament loaded and ready to print"
    
    # Call nozzle cleaning macro if configured (before cooldown)
    {% set nozzle_clean_macro = buffer_vars.nozzle_clean_macro|string|trim %}
    {% if nozzle_clean_macro and nozzle_clean_macro != "" %}
        RESPOND MSG="Running nozzle cleaning: {nozzle_clean_macro}..."
        {% if nozzle_clean_macro == "CLEAN_NOZZLE" %}
            CLEAN_NOZZLE
        {% elif nozzle_clean_macro == "NOZZLE_CLEAN" %}
            NOZZLE_CLEAN
        {% elif nozzle_clean_macro == "CLEAN" %}
            CLEAN
        {% elif nozzle_clean_macro == "NOZZLE_CLEANING" %}
            NOZZLE_CLEANING
        {% else %}
            RESPOND MSG="⚠ Unknown nozzle cleaning macro: {nozzle_clean_macro}"
            RESPOND MSG="Please add it to the conditional check or call it manually"
        {% endif %}
        M400
    {% endif %}
    
    # Optional cooldown (last step)
    {% if cool|lower in ['yes', 'true'] %}
        {% if printer.print_stats.state not in ['printing', 'paused'] and (temp >= printer.configfile.settings['extruder'].min_extrude_temp) %}
            SET_DISPLAY_TEXT MSG="Post load hotend cooling..."
            RESPOND MSG="Post load hotend cooling to {cool_temp}°C..."
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cool_temp|int}
            M117
        {% elif printer.print_stats.state in ['printing', 'paused'] %}
            SET_DISPLAY_TEXT MSG="Load cooling denied, print in progress!"
            RESPOND MSG="Load cooling denied, print in progress!"
        {% endif %}
    {% endif %}


#####################################################################
# Buffer_Retract_Until_Runout - Buffer Retraction Helper
#####################################################################
# Retracts filament via buffer until runout sensor detects no filament
# Uses continuous retraction, polls sensor periodically
# Maximum retraction time: 60 seconds (configurable via TIMEOUT parameter)
#
# Parameters:
#   TIMEOUT: Maximum retraction time in seconds (default: 60)
#   POLL: Poll interval in seconds (default: 0.5)
#
# Usage: Buffer_Retract_Until_Runout [TIMEOUT=60] [POLL=0.5]
#####################################################################

[gcode_macro Buffer_Retract_Until_Runout]
description: Retract buffer until runout sensor detects no filament
gcode:
    {% set timeout = params.TIMEOUT|default(60)|int %}  # Maximum time in seconds
    {% set poll_interval = params.POLL|default(0.5)|float %}  # Poll interval in seconds
    {% set timeout_ms = timeout * 1000 %}
    {% set poll_ms = poll_interval * 1000 %}
    {% set max_iterations = (timeout_ms / poll_ms) | int %}
    
    RESPOND MSG="Starting continuous buffer retraction until runout detected..."
    RESPOND MSG="Timeout: {timeout}s (safety limit) | Poll: {poll_interval}s"
    
    # Ensure feed button is released
    SET_PIN PIN=_Feed_Button VALUE=1
    M400
    
    # Check if sensor is already LOW (no filament detected)
    {% if not printer["filament_switch_sensor filament_sensor"].filament_detected %}
        RESPOND MSG="Runout sensor already shows no filament - skipping retraction"
        RESPOND MSG="Filament may already be ejected or sensor issue detected"
    {% else %}
        RESPOND MSG="Retracting filament continuously until runout detected..."
        
        # Start continuous retraction
        SET_PIN PIN=_Retract_Button VALUE=0  # Press retract button (LOW = pressed)
        M400
        
        {% set filament_detected = True %}
        {% set elapsed = 0 %}
        
        # Loop through iterations (each iteration = poll_interval)
        {% for i in range(max_iterations) %}
            {% if filament_detected %}
                {% set iteration = i + 1 %}
                {% set elapsed = elapsed + poll_ms %}
                
                # Wait for poll interval
                G4 P{poll_ms | int}
                
                # Check sensor state - stop immediately when no filament detected
                {% if not printer["filament_switch_sensor filament_sensor"].filament_detected %}
                    {% set filament_detected = False %}
                    SET_PIN PIN=_Retract_Button VALUE=1  # Stop retraction immediately
                    RESPOND MSG="✓ Runout detected! Filament ejected."
                    RESPOND MSG="✓ Buffer retraction complete - total time: {elapsed / 1000 | int} seconds"
                {% elif iteration % 4 == 0 %}  # Report every 2 seconds (4 * 0.5s)
                    {% if elapsed < timeout_ms %}
                        RESPOND MSG="Retracting... ({elapsed / 1000 | int}s elapsed, {timeout - (elapsed / 1000 | int)}s remaining)"
                    {% else %}
                        RESPOND MSG="Retracting... ({elapsed / 1000 | int}s elapsed - safety timeout reached, still checking sensor...)"
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endfor %}
        
        # Final check and cleanup
        SET_PIN PIN=_Retract_Button VALUE=1  # Ensure button is released
        
        {% if filament_detected %}
            RESPOND MSG="⚠ TIMEOUT: Buffer retraction stopped after {timeout} seconds (safety limit)"
            RESPOND MSG="Filament may still be in buffer - check manually"
            {% if printer["filament_switch_sensor filament_sensor"].filament_detected %}
                RESPOND MSG="Sensor state: FILAMENT DETECTED"
            {% else %}
                RESPOND MSG="Sensor state: NO FILAMENT"
            {% endif %}
        {% endif %}
    {% endif %}
    
    M400  # Wait for all operations to complete

