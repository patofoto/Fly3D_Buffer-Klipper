#####################################################################
# TEST_EXTRUDER_UNLOAD - Standalone Extruder Unload Test
#####################################################################
# Tests only the extruder purge and retraction phases
# Excludes all buffer operations for timing measurements
#
# This file requires mellow_buffer_macros.cfg to be loaded first
# (it references variables from _BUFFER_STANDALONE_VARS)
#
# Usage:
#   TEST_EXTRUDER_UNLOAD
#   TEST_EXTRUDER_UNLOAD TEMP=230 SPEED=5
#   TEST_EXTRUDER_UNLOAD TEMP=230 SPEED=5 UNLOAD_LENGTH=150
#
# Add to printer.cfg:
#   [include mellow_buffer_macros.cfg]
#   [include test_extruder_unload.cfg]
#####################################################################

[gcode_macro TEST_EXTRUDER_UNLOAD]
description: Test extruder purge and retraction only (no buffer operations) with running timer
gcode:
    # Get configuration from buffer standalone variables
    {% set buffer_vars = printer["gcode_macro _BUFFER_STANDALONE_VARS"] %}
    {% set unload_length = buffer_vars.unload_length|float %}
    {% set unload_purge_length = buffer_vars.unload_purge_length|float %}
    {% set default_temp = buffer_vars.unload_temp|int %}
    {% set default_speed = buffer_vars.unload_speed|float %}
    {% set hotend_path_length = buffer_vars.hotend_path_length|float %}
    {% set buffer_retract_delay = buffer_vars.buffer_retract_delay|float %}
    
    # Allow parameter overrides
    {% set temp = params.TEMP|default(default_temp)|int %}
    {% set speed_mmsec = params.SPEED|default(default_speed)|float %}
    {% set speed = speed_mmsec * 60 %}  # Convert to mm/min
    {% set override_unload_length = params.UNLOAD_LENGTH|default(0)|float %}
    {% if override_unload_length > 0 %}
        {% set unload_length = override_unload_length %}
    {% endif %}
    
    # Get max velocity from extruder config and ensure speed doesn't exceed it
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity|int * 60 %}
    {% if speed > max_velocity %}
        {% set speed = max_velocity %}
    {% endif %}
    
    RESPOND MSG="TEST_EXTRUDER_UNLOAD starting..."
    RESPOND MSG="Unload: {unload_length}mm | Purge: {unload_purge_length}mm | Temp: {temp}°C | Speed: {speed_mmsec}mm/s"
    RESPOND MSG="NOTE: This test excludes all buffer operations"
    
    # Save G-code state
    SAVE_GCODE_STATE NAME=test_extruder_unload_state
    
    # Temperature management (required for purge to work)
    {% if printer.print_stats.state not in ['printing', 'paused'] %}
        {% if 'TEMP' not in params %}
            {% if (printer.extruder.target == 0) or (printer.extruder.target < printer.configfile.settings['extruder'].min_extrude_temp) %}
                SET_DISPLAY_TEXT MSG="Test hotend heating..."
                RESPOND MSG="Test hotend heating to {temp}°C..."
                SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
                TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
                M117
            {% elif printer.extruder.target != 0 and printer.extruder.target >= printer.configfile.settings['extruder'].min_extrude_temp %}
                SET_DISPLAY_TEXT MSG="Testing hotend..."
                RESPOND MSG="Testing hotend at {printer.extruder.target|int}°C..."
                TEMPERATURE_WAIT SENSOR=extruder MINIMUM={printer.extruder.target|int -2} MAXIMUM={printer.extruder.target|int + 5}
            {% endif %}
        {% else %}
            SET_DISPLAY_TEXT MSG="Test hotend heating to {temp}°C"
            RESPOND MSG="Test hotend heating to {temp}°C"
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
            TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
        {% endif %}
    {% endif %}
    
    # Extruder unload sequence (same structure as BUFFER_UNLOAD_FILAMENT)
    RESPOND MSG="Starting filament unload from hotend..."
    M83  # Relative extrusion
    G92 E0  # Reset extruder
    
    # TIMER STARTS HERE - Purge to prevent cold end clogging
    RESPOND MSG="⏱ TIMER STARTED - Purging {unload_purge_length}mm to clear cold end..."
    {% set timer_start = 0 %}  # We'll track time from here
    {% set elapsed_time = 0 %}
    
    # Calculate purge time
    {% set purge_time = (unload_purge_length / speed_mmsec) %}
    {% set purge_time_ms = (purge_time * 1000) | int %}
    {% set timer_update_interval = 500 %}  # Update timer every 0.5 seconds
    {% set timer_updates = (purge_time_ms / timer_update_interval) | int %}
    
    # Start purge with timer updates
    G1 E{unload_purge_length|float} F{speed|int}
    # Report timer during purge (non-blocking, just informational)
    {% for i in range(timer_updates + 1) %}
        {% set elapsed = (i * timer_update_interval) / 1000.0 %}
        {% if i > 0 %}
            RESPOND MSG="⏱ Timer: {elapsed|round(2)}s (purge in progress...)"
        {% endif %}
    {% endfor %}
    M400
    {% set elapsed_time = purge_time %}
    RESPOND MSG="⏱ Timer: {elapsed_time|round(2)}s - Purge complete"
    
    # Small retract to break adhesion
    {% set small_retract_time = (5.0 / speed_mmsec) %}
    RESPOND MSG="Small retract 5mm to break adhesion..."
    G1 E-5 F{speed|int}
    M400
    {% set elapsed_time = elapsed_time + small_retract_time %}
    RESPOND MSG="⏱ Timer: {elapsed_time|round(2)}s - Small retract complete"
    
    # Calculate initial retraction distance and delay for simultaneous operation
    # Initial retraction: 30-40% of hotend path or 30mm minimum (whichever is larger, capped at 40mm)
    {% set initial_retract_pct = 0.35 %}  # 35% of hotend path (increased from 25% for better disengagement)
    {% set min_initial_retract = 30.0 %}  # Increased from 20mm
    {% set max_initial_retract = 40.0 %}  # Increased from 30mm
    {% set calculated_initial = hotend_path_length * initial_retract_pct %}
    {% if calculated_initial < min_initial_retract %}
        {% set initial_retract_length = min_initial_retract %}
    {% elif calculated_initial > max_initial_retract %}
        {% set initial_retract_length = max_initial_retract %}
    {% else %}
        {% set initial_retract_length = calculated_initial %}
    {% endif %}
    
    # Calculate remaining retraction after initial phase
    {% set remaining_retract_length = unload_length - initial_retract_length %}
    {% if remaining_retract_length < 0 %}
        {% set remaining_retract_length = 0 %}
        {% set initial_retract_length = unload_length %}
    {% endif %}
    
    # Calculate delay dynamically: time to pull initial retract + motor acceleration + safety margin
    # Time to pull initial retract = distance / speed
    {% set initial_retract_time = initial_retract_length / speed_mmsec %}
    {% set motor_accel_time = 0.5 %}  # Increased from 0.3s (more conservative estimate)
    {% set safety_margin = 0.8 %}  # Increased from 0.2s (more time for physical disengagement)
    {% set calculated_delay = initial_retract_time + motor_accel_time + safety_margin %}
    # Use calculated delay or configured delay, whichever is larger (safety)
    # buffer_retract_delay now acts as a minimum floor
    {% if calculated_delay > buffer_retract_delay %}
        {% set actual_delay = calculated_delay %}
    {% else %}
        {% set actual_delay = buffer_retract_delay %}
    {% endif %}
    
    # Phase 1: Initial retraction to disengage filament from hotend
    RESPOND MSG="Phase 1: Initial retraction {initial_retract_length|round(1)}mm to disengage from hotend..."
    RESPOND MSG="Calculated delay: {actual_delay|round(2)}s (initial: {initial_retract_time|round(2)}s + accel: {motor_accel_time}s + margin: {safety_margin}s)"
    G1 E-{initial_retract_length|float} F{speed|int}
    M400  # Wait for initial retraction to complete
    {% set elapsed_time = elapsed_time + initial_retract_time %}
    RESPOND MSG="⏱ Timer: {elapsed_time|round(2)}s - Phase 1 (initial retraction) complete"
    
    # Brief delay to ensure filament is disengaged (same as in full unload, but no buffer call)
    {% set delay_ms = (actual_delay * 1000) | int %}
    RESPOND MSG="Waiting {actual_delay|round(2)}s delay (simulating buffer start timing)..."
    
    # Report timer during delay period (every 0.5 seconds)
    {% set delay_updates = (delay_ms / timer_update_interval) | int %}
    {% for i in range(delay_updates) %}
        G4 P{timer_update_interval}
        {% set elapsed_time = elapsed_time + (timer_update_interval / 1000.0) %}
        RESPOND MSG="⏱ Timer: {elapsed_time|round(2)}s (delay in progress...)"
    {% endfor %}
    # Complete any remaining delay time
    {% set remaining_delay = delay_ms - (delay_updates * timer_update_interval) %}
    {% if remaining_delay > 0 %}
        G4 P{remaining_delay}
        {% set elapsed_time = elapsed_time + (remaining_delay / 1000.0) %}
    {% endif %}
    RESPOND MSG="⏱ Timer: {elapsed_time|round(2)}s - Delay complete"
    
    # Phase 2: Remaining hotend retraction (would normally run simultaneously with buffer)
    {% if remaining_retract_length > 0 %}
        {% set remaining_retract_time = (remaining_retract_length / speed_mmsec) %}
        RESPOND MSG="Phase 2: Continuing hotend retraction {remaining_retract_length|round(1)}mm..."
        G1 E-{remaining_retract_length|float} F{speed|int}
        M400  # Wait for remaining retraction to complete
        {% set elapsed_time = elapsed_time + remaining_retract_time %}
        RESPOND MSG="⏱ Timer: {elapsed_time|round(2)}s - Phase 2 (remaining retraction) complete"
    {% endif %}
    
    RESPOND MSG="⏱⏱⏱ FINAL TIMER: {elapsed_time|round(2)}s ⏱⏱⏱"
    RESPOND MSG="Extruder unload test complete!"
    RESPOND MSG="Total retraction: {unload_length}mm (initial: {initial_retract_length|round(1)}mm + remaining: {remaining_retract_length|round(1)}mm)"
    
    # Restore G-code state
    RESTORE_GCODE_STATE NAME=test_extruder_unload_state
    
    M400
    SET_DISPLAY_TEXT MSG="TEST_EXTRUDER_UNLOAD complete!"
    RESPOND MSG="Timer stopped at {elapsed_time|round(2)}s"

