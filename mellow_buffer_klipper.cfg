#####################################################################
# 	LLL Plus Filament Buffer Configuration
#####################################################################
# This config interfaces Klipper with the Mellow/Fly buffer board
# 
# IMPORTANT PIN SELECTION NOTES:
# - PA8 and PC9 were chosen because they default to HIGH on boot
# - This prevents the buffer motor from moving during Klipper startup
# - The buffer firmware uses active-low button logic:
#   * LOW (0) = button pressed = motor moves
#   * HIGH (1) = button released = motor idle
# - Do NOT use pins that default LOW on boot (like PC15, PE9)
#   as they will trigger unwanted motor movement
#####################################################################

[filament_switch_sensor filament_sensor]
# Original name: [filament_switch_sensor Material_breakage_detection]
pause_on_runout: true
switch_pin: PF4 # White Wire (PB15 on buffer board)
runout_gcode:
    PAUSE
    RESPOND MSG="Filament runout triggered"
    #SET_IDLE_TIMEOUT TIMEOUT=86400
insert_gcode:
    RESPOND MSG="Triggered feeding"
event_delay: 2.0
pause_delay: 2.0
debounce_delay:2.0

[gcode_button Trigger Feeding]
pin:^!PF1 # White Wire (PA2 on buffer board)
press_gcode:
    RESPOND MSG="Triggered feeding"
    # Custom Gcode

[gcode_button Trigger Retraction]
pin:^!PF0 # Red Wire (PA3 on buffer board)
press_gcode:
    RESPOND MSG="Triggered retraction"
    # Custom Gcode

[output_pin _Feed_Button]
# Pin PA8 chosen for its default HIGH state on boot (prevents motor movement during Klipper startup)
# Buffer firmware expects: HIGH = button released, LOW = button pressed
# No inversion (!) needed - value:1 outputs HIGH directly
pin:PA8 # White Wire (PB5 on buffer board / KEY2 Forward button)
value:1  # HIGH on boot = button released = motor stays still

[output_pin _Retract_Button]
# Pin PC9 chosen for its default HIGH state on boot (prevents motor movement during Klipper startup)
# Buffer firmware expects: HIGH = button released, LOW = button pressed
# No inversion (!) needed - value:1 outputs HIGH directly
pin:PC9 # Black Wire (PB6 on buffer board / KEY1 Reverse button)
value:1  # HIGH on boot = button released = motor stays still

[gcode_macro Buffer_Feeding]  ## Buffer Feeding
# Manually triggers the buffer to feed filament forward for 10 seconds
# Buffer button logic: VALUE=0 (LOW) = pressed, VALUE=1 (HIGH) = released
gcode:
    SET_PIN PIN=_Retract_Button VALUE=1  # Ensure retract button is released
    SET_PIN PIN=_Feed_Button VALUE=0     # Press feed button (LOW = pressed)
    G4 P10000                            # Hold for 10 seconds
    SET_PIN PIN=_Feed_Button VALUE=1     # Release feed button (HIGH = released)

[gcode_macro Buffer_Retraction]  ## Buffer Retraction
# Manually triggers the buffer to retract filament backward for 10 seconds
# Buffer button logic: VALUE=0 (LOW) = pressed, VALUE=1 (HIGH) = released
gcode:
    SET_PIN PIN=_Feed_Button VALUE=1        # Ensure feed button is released
    SET_PIN PIN=_Retract_Button VALUE=0     # Press retract button (LOW = pressed)
    G4 P10000                               # Hold for 10 seconds
    SET_PIN PIN=_Retract_Button VALUE=1     # Release retract button (HIGH = released)